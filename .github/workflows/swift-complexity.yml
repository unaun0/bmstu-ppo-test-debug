name: Swift Complexity

on:
  pull_request:
  push:

jobs:
  complexity:
    runs-on: macos-14

    env:
      COMPLEXITY_JSON: complexity.json
      COMPLEXITY_HTML: complexity-report

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: SwiftyLab/setup-swift@latest
        with:
          swift-version: "6.1"

      - name: Build swift-complexity
        run: |
          git clone https://github.com/fummicc1/swift-complexity.git
          cd swift-complexity
          swift build -c release
          sudo cp .build/release/SwiftComplexityCLI /usr/local/bin/swift-complexity

      - name: Generate cognitive complexity report
        run: |
          swift-complexity src/Sources \
            --recursive \
            --format json \
            --cognitive-only \
            > $COMPLEXITY_JSON

      - name: Generate HTML report
        run: |
          python3 src/TestScripts/comp_report.py \
            --input $COMPLEXITY_JSON \
            --output $COMPLEXITY_HTML/report.html

      - name: Upload complexity artifacts
        uses: actions/upload-artifact@v4
        with:
          name: complexity-artifacts
          path: |
            $COMPLEXITY_JSON
            $COMPLEXITY_HTML/
      
      - name: Publish Complexity Report to Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: $COMPLEXITY_HTML
          publish_branch: complexity-pages
